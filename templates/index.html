<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS KOKORO - Complete Audio Solution</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6baf;
            --primary-hover: #3a5999;
            --secondary-color: #6c757d;
            --light-bg: #f8f9fa;
            --dark-text: #333;
            --light-text: #f8f9fa;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --gradient-start: #6a11cb;
            --gradient-end: #2575fc;
        }

        body {
            background-color: var(--light-bg);
            color: var(--dark-text);
            transition: background-color 0.3s ease, color 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        body.dark-mode {
            --primary-color: #5a7bc7;
            --light-bg: #1a1a1a;
            --dark-text: #e0e0e0;
            --border-color: #333;
            --secondary-color: #a0a0a0;
            --success-color: #4CAF50;
            --danger-color: #F44336;
            --warning-color: #FFC107;
            --info-color: #2196F3;
            background-color: #121212;
        }

        .app-container {
            background: #ffffff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 1000px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body.dark-mode .app-container {
            background: #1e1e1e;
            color: var(--dark-text);
            border-color: #444;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700;
        }

        .text-input,
        .form-select,
        .form-control {
            background: var(--light-bg);
            color: var(--dark-text);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        body.dark-mode .text-input,
        body.dark-mode .form-select,
        body.dark-mode .form-control {
            background: #2a2a2a;
            color: var(--dark-text);
            border-color: #444;
        }

        .text-input:focus,
        .form-select:focus,
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(74, 107, 175, 0.25);
            background-color: var(--light-bg);
            color: var(--dark-text);
        }

        body.dark-mode .text-input:focus,
        body.dark-mode .form-select:focus,
        body.dark-mode .form-control:focus {
            background-color: #2a2a2a;
            color: var(--dark-text);
        }

        .btn {
            border-radius: 8px;
            font-weight: 600;
            padding: 10px 20px;
            transition: all 0.2s ease;
            transform: translateY(0);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            color: var(--light-text);
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }

        .btn-info {
            background-color: var(--info-color);
            border-color: var(--info-color);
        }

        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        /* NEW: STT Specific Styles */
        .stt-section {
            border: 2px solid var(--info-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, rgba(23, 162, 184, 0.1), rgba(23, 162, 184, 0.05));
        }

        body.dark-mode .stt-section {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(33, 150, 243, 0.05));
            border-color: var(--info-color);
        }

        .recording-indicator {
            display: none;
            color: var(--danger-color);
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .file-drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            color: var(--secondary-color);
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(74, 107, 175, 0.05);
        }

        .file-drop-zone:hover,
        .file-drop-zone.dragover {
            border-color: var(--primary-color);
            background: rgba(74, 107, 175, 0.1);
            color: var(--primary-color);
        }

        .transcription-result {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        body.dark-mode .transcription-result {
            background: #2a2a2a;
            border-color: #444;
        }

        /* Enhanced notification styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        .notification {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            min-width: 200px;
            text-align: center;
        }

        .notification.show {
            opacity: 1;
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
        }

        .notification.error {
            background-color: var(--danger-color);
        }

        .notification.info {
            background-color: var(--info-color);
        }

        #readingStatus {
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--secondary-color);
            min-height: 20px;
        }

        .progress-container {
            width: 100%;
            background-color: var(--border-color);
            border-radius: 5px;
            margin-top: 10px;
            height: 10px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 5px;
            transition: width 0.1s linear;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: var(--light-bg);
            flex-wrap: wrap;
        }

        body.dark-mode .audio-controls {
            background-color: #2a2a2a;
            border-color: #444;
        }

        .volume-control-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .volume-control-container input[type="range"] {
            width: 80px;
            margin: 0;
        }

        #dark-mode-toggle-container {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #dark-mode-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        #dark-mode-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* Workflow tabs */
        .workflow-tabs {
            margin-bottom: 20px;
        }

        .workflow-tabs .nav-link {
            color: var(--dark-text);
            border: 1px solid var(--border-color);
            background: var(--light-bg);
            transition: all 0.3s ease;
        }

        body.dark-mode .workflow-tabs .nav-link {
            background: #2a2a2a;
            border-color: #444;
        }

        .workflow-tabs .nav-link.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .workflow-tabs .nav-link:hover {
            background: var(--primary-hover);
            color: white;
            border-color: var(--primary-hover);
        }

        /* Language detection badge */
        .language-badge {
            display: inline-block;
            background: var(--info-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <div id="dark-mode-toggle-container">
        <label id="dark-mode-label" for="dark-mode-checkbox">Light Mode</label>
        <label class="switch" id="dark-mode-toggle">
            <input type="checkbox" id="dark-mode-checkbox">
            <span class="slider"></span>
        </label>
    </div>

    <div class="app-container">
        <h1 class="mb-4">
            <i class="fas fa-microphone-alt"></i> TTS KOKORO
            <small class="text-muted d-block" style="font-size: 0.5em;">Complete Audio Solution</small>
        </h1>

        <div class="notification-container" id="notificationContainer"></div>

        <ul class="nav nav-tabs workflow-tabs" id="workflowTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="stt-tab" data-bs-toggle="tab" data-bs-target="#stt-content" type="button" role="tab" aria-controls="stt-content" aria-selected="true">
                    <i class="fas fa-microphone"></i> Speech → Text
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit-content" type="button" role="tab" aria-controls="edit-content" aria-selected="false">
                    <i class="fas fa-edit"></i> Edit Text
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tts-tab" data-bs-toggle="tab" data-bs-target="#tts-content" type="button" role="tab" aria-controls="tts-content" aria-selected="false">
                    <i class="fas fa-volume-up"></i> Text → Speech
                </button>
            </li>
        </ul>

        <div class="tab-content" id="workflowTabContent">

            <div class="tab-pane fade show active" id="stt-content" role="tabpanel" aria-labelledby="stt-tab">
                <div class="stt-section">
                    <h4><i class="fas fa-microphone"></i> Speech to Text</h4>
                    <p class="text-muted">Convert audio to text using AI transcription</p>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Upload Audio File</label>
                            <div class="file-drop-zone" id="audioDropZone">
                                <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                <p>Drag & drop audio files here</p>
                                <p class="small">Supports: MP3, WAV, OGG, M4A, FLAC</p>
                                <button class="btn btn-info btn-sm mt-2" id="selectAudioBtn">
                                    <i class="fas fa-folder-open"></i> Select File
                                </button>
                            </div>
                            <input type="file" id="audioFileInput" class="d-none" accept=".mp3,.wav,.ogg,.m4a,.flac,.webm">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Live Recording</label>
                            <div class="d-grid gap-2">
                                <button class="btn btn-danger" id="recordBtn">
                                    <i class="fas fa-microphone"></i> Start Recording
                                </button>
                                <button class="btn btn-secondary" id="stopRecordBtn" disabled>
                                    <i class="fas fa-stop"></i> Stop Recording
                                </button>
                                <div class="recording-indicator" id="recordingIndicator">
                                    <i class="fas fa-circle"></i> Recording...
                                </div>
                            </div>
                            <small class="text-muted">Uses browser's speech recognition</small>
                        </div>
                    </div>

                    <div class="transcription-result" id="transcriptionResult">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6><i class="fas fa-file-alt"></i> Transcription Result</h6>
                            <div>
                                <span class="language-badge" id="detectedLanguage" style="display: none;"></span>
                                <button class="btn btn-success btn-sm" id="useTranscriptionBtn">
                                    <i class="fas fa-arrow-right"></i> Use This Text
                                </button>
                            </div>
                        </div>
                        <div class="form-floating">
                            <textarea class="form-control" id="transcriptionText" style="height: 120px;" readonly></textarea>
                            <label for="transcriptionText">Transcribed text will appear here...</label>
                        </div>
                        <div class="mt-2 small text-muted">
                            <span id="transcriptionStats"></span>
                        </div>
                    </div>

                    <div class="mt-3">
                        <div id="sttStatus" class="text-center text-muted">
                            <i class="fas fa-info-circle"></i> Ready for speech recognition
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="edit-content" role="tabpanel" aria-labelledby="edit-tab">
                <div class="mb-3">
                    <label for="textInput" class="form-label">Text to Speak <span id="charCount" class="text-muted small ms-2">0 characters</span></label>
                    <textarea class="form-control text-input" id="textInput" rows="8" placeholder="Enter text here, or get text from Speech → Text tab..."></textarea>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div>
                            <button class="btn btn-secondary btn-sm" id="copyTextBtn">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button class="btn btn-secondary btn-sm ms-2" id="clearTextBtn">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                        </div>
                        <div>
                            <input type="file" id="fileImport" class="d-none" accept=".txt">
                            <button class="btn btn-secondary btn-sm" id="importFileBtn">
                                <i class="fas fa-file-upload"></i> Import .txt
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle w-100" type="button" id="templatesDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-file-alt"></i> Templates
                            </button>
                            <ul class="dropdown-menu" id="templatesList" aria-labelledby="templatesDropdown">
                                <li><a class="dropdown-item" href="#" data-template="Welcome message">Welcome message</a></li>
                                <li><a class="dropdown-item" href="#" data-template="Announcement">Announcement</a></li>
                                <li><a class="dropdown-item" href="#" data-template="Quick test">Quick test</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle w-100" type="button" id="historyDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-history"></i> History
                            </button>
                            <ul class="dropdown-menu" id="historyList" aria-labelledby="historyDropdown">
                                <li><a class="dropdown-item disabled" href="#">No history yet...</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle w-100" type="button" id="snippetsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-bookmark"></i> Snippets
                            </button>
                            <ul class="dropdown-menu" id="snippetsList" aria-labelledby="snippetsDropdown">
                                <li><a class="dropdown-item disabled" href="#">No snippets saved...</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tts-content" role="tabpanel" aria-labelledby="tts-tab">
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="voiceSelect" class="form-label">Select Voice</label>
                        <select class="form-select" id="voiceSelect" aria-label="Select Voice">
                            <optgroup label="Piper Voices">
                                {% for voice in piper_voices %}
                                <option value="piper:{{ voice.id }}" data-language="{{ voice.language }}" data-gender="{{ voice.gender }}">
                                    {{ voice.name }} ({{ voice.language }} - {{ voice.gender }})
                                </option>
                                {% endfor %}
                            </optgroup>
                        </select>
                        <div class="mt-2 text-end">
                            <button class="btn btn-sm btn-info" id="voicePreviewBtn">
                                <i class="fas fa-play"></i> Preview
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="speedSelect" class="form-label">Speed</label>
                        <select class="form-select" id="speedSelect" aria-label="Select Speed">
                            <option value="0.75">0.75x</option>
                            <option value="1.0" selected>1.0x (Normal)</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2.0">2.0x</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="outputFormatSelect" class="form-label">Format</label>
                        <select class="form-select" id="outputFormatSelect" aria-label="Select Format">
                            <option value="wav" selected>WAV</option>
                            <option value="mp3">MP3</option>
                            <option value="ogg">OGG</option>
                        </select>
                    </div>
                </div>
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-primary btn-lg" id="readBtn">
                        <i class="fas fa-volume-up"></i> Generate Speech
                    </button>
                </div>
                <div id="readingStatus" class="text-center text-muted">
                    <i class="fas fa-circle-notch fa-spin"></i> Initializing...
                </div>
                <div class="audio-controls" id="audioControls" style="display:none;">
                    <audio id="audioPlayer" controls style="display:none;"></audio>
                    <button class="btn btn-secondary" id="playPauseBtn">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-danger" id="stopBtn" disabled>
                        <i class="fas fa-stop"></i>
                    </button>
                    <div class="progress-container flex-grow-1" id="progressBarContainer">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="volume-control-container">
                        <i class="fas fa-volume-up"></i>
                        <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1">
                    </div>
                    <button class="btn btn-success" id="downloadAudioBtn" disabled>
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Element References ---
            const textInput = document.getElementById('textInput');
            const readBtn = document.getElementById('readBtn');
            const stopBtn = document.getElementById('stopBtn');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const audioPlayer = document.getElementById('audioPlayer');
            const voiceSelect = document.getElementById('voiceSelect');
            const speedSelect = document.getElementById('speedSelect');
            const outputFormatSelect = document.getElementById('outputFormatSelect');
            const readingStatus = document.getElementById('readingStatus');
            const downloadAudioBtn = document.getElementById('downloadAudioBtn');
            const notificationContainer = document.getElementById('notificationContainer');
            const charCount = document.getElementById('charCount');
            const copyTextBtn = document.getElementById('copyTextBtn');
            const clearTextBtn = document.getElementById('clearTextBtn');
            const darkmodeToggleCheckbox = document.getElementById('dark-mode-checkbox');
            const darkmodeLabel = document.getElementById('dark-mode-label');
            const progressBar = document.getElementById('progressBar');
            const progressBarContainer = document.getElementById('progressBarContainer');
            const volumeControl = document.getElementById('volumeControl');
            const audioControls = document.getElementById('audioControls');
            const voicePreviewBtn = document.getElementById('voicePreviewBtn');

            // NEW: STT Elements
            const audioDropZone = document.getElementById('audioDropZone');
            const selectAudioBtn = document.getElementById('selectAudioBtn');
            const audioFileInput = document.getElementById('audioFileInput');
            const recordBtn = document.getElementById('recordBtn');
            const stopRecordBtn = document.getElementById('stopRecordBtn');
            const recordingIndicator = document.getElementById('recordingIndicator');
            const transcriptionResult = document.getElementById('transcriptionResult');
            const transcriptionText = document.getElementById('transcriptionText');
            const detectedLanguage = document.getElementById('detectedLanguage');
            const useTranscriptionBtn = document.getElementById('useTranscriptionBtn');
            const transcriptionStats = document.getElementById('transcriptionStats');
            const sttStatus = document.getElementById('sttStatus');

            // Global variables
            let currentAudio = null;
            let isReading = false;
            let isPaused = false;
            let currentDownloadPath = null;
            let isRecording = false;
            let recognition = null;
            let sttAvailable = false;
            let accumulatedTranscript = ''; // NEW: To store continuous transcription

            // --- Utility Functions ---
            function showNotification(message, type = 'info', duration = 3000) {
                const notification = document.createElement('div');
                notification.classList.add('notification', type);
                notification.textContent = message;
                notificationContainer.appendChild(notification);
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                setTimeout(() => {
                    notification.classList.remove('show');
                    notification.addEventListener('transitionend', () => notification.remove());
                }, duration);
            }

            function updateReadingStatus(message, icon = 'fas fa-circle-notch fa-spin') {
                readingStatus.innerHTML = `<i class="${icon}"></i> ${message}`;
            }

            function updateSTTStatus(message, icon = 'fas fa-info-circle') {
                sttStatus.innerHTML = `<i class="${icon}"></i> ${message}`;
            }

            // --- Dark Mode ---
            function applyDarkMode(isDark) {
                if (isDark) {
                    document.body.classList.add('dark-mode');
                    darkmodeLabel.textContent = 'Dark Mode';
                } else {
                    document.body.classList.remove('dark-mode');
                    darkmodeLabel.textContent = 'Light Mode';
                }
                localStorage.setItem('darkMode', isDark);
            }

            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                darkmodeToggleCheckbox.checked = true;
                applyDarkMode(true);
            } else {
                darkmodeToggleCheckbox.checked = false;
                applyDarkMode(false);
            }

            darkmodeToggleCheckbox.addEventListener('change', (event) => {
                applyDarkMode(event.target.checked);
            });

            // --- Text Management ---
            textInput.addEventListener('input', function () {
                const count = this.value.length;
                charCount.textContent = `${count} characters`;
                saveTextToLocalStorage();
            });

            function saveTextToLocalStorage() {
                localStorage.setItem('ttsKokoroTextInput', textInput.value);
            }

            function loadTextFromLocalStorage() {
                const savedText = localStorage.getItem('ttsKokoroTextInput');
                if (savedText) {
                    textInput.value = savedText;
                    charCount.textContent = `${savedText.length} characters`;
                }
            }
            loadTextFromLocalStorage();

            copyTextBtn.addEventListener('click', function () {
                navigator.clipboard.writeText(textInput.value).then(() => {
                    showNotification('Text copied to clipboard!', 'success');
                }).catch(err => {
                    showNotification('Failed to copy text.', 'error');
                });
            });

            clearTextBtn.addEventListener('click', function () {
                if (confirm('Clear all text?')) {
                    textInput.value = '';
                    charCount.textContent = `0 characters`;
                    saveTextToLocalStorage();
                    showNotification('Text cleared!', 'info');
                }
            });

            // --- NEW: Speech-to-Text Functions ---

            // Check STT availability
            async function checkSTTAvailability() {
                try {
                    const response = await fetch('/check_stt_availability');
                    const data = await response.json();
                    sttAvailable = data.whisper_available;
                    if (sttAvailable) {
                        updateSTTStatus("STT ready - Upload audio or use microphone", 'fas fa-check-circle');
                    } else {
                        updateSTTStatus("STT (Whisper) not available. See backend console for install info.", 'fas fa-exclamation-triangle');
                        // Disable upload and record buttons if STT is not available
                        selectAudioBtn.disabled = true;
                        recordBtn.disabled = true;
                        audioDropZone.style.pointerEvents = 'none';
                        audioDropZone.style.opacity = '0.6';
                    }
                } catch (error) {
                    console.error('Error checking STT availability:', error);
                    updateSTTStatus("Failed to check STT availability.", 'fas fa-times-circle');
                    selectAudioBtn.disabled = true;
                    recordBtn.disabled = true;
                    audioDropZone.style.pointerEvents = 'none';
                    audioDropZone.style.opacity = '0.6';
                }
            }

            // Audio File Upload (Drag & Drop and Select File)
            audioDropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                audioDropZone.classList.add('dragover');
            });

            audioDropZone.addEventListener('dragleave', () => {
                audioDropZone.classList.remove('dragover');
            });

            audioDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                audioDropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processAudioFile(files[0]);
                }
            });

            selectAudioBtn.addEventListener('click', () => {
                audioFileInput.click();
            });

            audioFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    processAudioFile(e.target.files[0]);
                }
            });

            async function processAudioFile(file) {
                if (!sttAvailable) {
                    showNotification("Speech-to-Text feature is not available.", "error");
                    return;
                }

                const formData = new FormData();
                formData.append('audio_file', file);

                updateSTTStatus('Transcribing audio...', 'fas fa-circle-notch fa-spin');
                showNotification('Uploading and transcribing audio...', 'info');

                try {
                    const response = await fetch('/transcribe_audio', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to transcribe audio');
                    }

                    const data = await response.json();
                    if (data.success && data.text) {
                        transcriptionText.value = data.text;
                        detectedLanguage.textContent = data.detected_language.toUpperCase();
                        detectedLanguage.style.display = 'inline-block';
                        transcriptionStats.textContent = `${data.character_count} characters`;
                        transcriptionResult.style.display = 'block';
                        updateSTTStatus('Transcription complete!', 'fas fa-check-circle');
                        showNotification('Audio transcribed successfully!', 'success');
                    } else {
                        showNotification(data.error || 'Unknown error during transcription.', 'error');
                        updateSTTStatus('Transcription failed.', 'fas fa-times-circle');
                        transcriptionResult.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Transcription Error:', error);
                    showNotification(`Error: ${error.message}`, 'error');
                    updateSTTStatus('Transcription failed.', 'fas fa-times-circle');
                    transcriptionResult.style.display = 'none';
                }
            }

            // Live Recording
            let mediaRecorder;
            let audioChunks = [];

            function initializeSpeechRecognition() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    recordBtn.disabled = true;
                    updateSTTStatus("Browser does not support Web Speech API for live recording.", 'fas fa-exclamation-triangle');
                    showNotification("Live recording not supported in this browser.", "warning", 5000);
                    return;
                }

                recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US'; // Default language, could be made dynamic

                recognition.onstart = () => {
                    console.log('Speech recognition started');
                    isRecording = true;
                    recordBtn.disabled = true;
                    stopRecordBtn.disabled = false;
                    recordingIndicator.style.display = 'inline';
                    updateSTTStatus('Recording live audio...', 'fas fa-dot-circle');
                    showNotification('Recording started.', 'info', 2000);
                    accumulatedTranscript = '';
                };

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    transcriptionText.value = accumulatedTranscript + finalTranscript + interimTranscript;
                    transcriptionResult.style.display = 'block';
                    transcriptionStats.textContent = `${transcriptionText.value.length} characters (Live)`;
                    // Simple language detection for live, could be improved
                    if (event.results.length > 0 && event.results[0][0].transcript) {
                        detectedLanguage.textContent = recognition.lang.split('-')[0].toUpperCase();
                        detectedLanguage.style.display = 'inline-block';
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    showNotification(`Recording error: ${event.error}`, 'error');
                    stopRecording(); // Stop on error
                };

                recognition.onend = () => {
                    console.log('Speech recognition ended');
                    if (isRecording) { // If it ended unexpectedly while still "recording"
                        stopRecording();
                        showNotification('Recording stopped unexpectedly.', 'warning');
                    }
                };
            }

            recordBtn.addEventListener('click', () => {
                if (!recognition) {
                    showNotification("Speech recognition not initialized.", "error");
                    return;
                }
                if (!isRecording) {
                    recognition.start();
                    // Setup MediaRecorder for actual audio chunks (if needed for server-side processing later)
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            mediaRecorder = new MediaRecorder(stream);
                            audioChunks = [];
                            mediaRecorder.ondataavailable = event => {
                                audioChunks.push(event.data);
                            };
                            mediaRecorder.onstop = async () => {
                                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' }); // Or appropriate type
                                const audioFile = new File([audioBlob], 'live_recording.wav', { type: 'audio/wav' });
                                // Optionally, send this blob to the server for Whisper transcription if needed
                                // Currently, the live transcription uses browser's Web Speech API
                                if (transcriptionText.value.trim()) {
                                    accumulatedTranscript = transcriptionText.value.trim();
                                }
                                updateSTTStatus("Live recording finished.", 'fas fa-check-circle');
                            };
                            mediaRecorder.start();
                        })
                        .catch(err => {
                            console.error('Error accessing microphone:', err);
                            showNotification('Failed to access microphone for recording.', 'error');
                            stopRecordBtn.disabled = true;
                            recordBtn.disabled = false;
                            recordingIndicator.style.display = 'none';
                            updateSTTStatus("Microphone access denied.", 'fas fa-times-circle');
                        });
                }
            });

            stopRecordBtn.addEventListener('click', () => {
                stopRecording();
            });

            function stopRecording() {
                if (isRecording) {
                    recognition.stop();
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                        mediaRecorder.stream.getTracks().forEach(track => track.stop()); // Stop microphone track
                    }
                    isRecording = false;
                    recordBtn.disabled = false;
                    stopRecordBtn.disabled = true;
                    recordingIndicator.style.display = 'none';
                    if (transcriptionText.value.trim()) {
                        accumulatedTranscript = transcriptionText.value.trim(); // Finalize transcript
                    }
                    updateSTTStatus('Recording stopped.', 'fas fa-stop-circle');
                    showNotification('Recording stopped.', 'info', 1500);
                }
            }

            useTranscriptionBtn.addEventListener('click', () => {
                if (transcriptionText.value.trim()) {
                    textInput.value = transcriptionText.value.trim();
                    charCount.textContent = `${textInput.value.length} characters`;
                    saveTextToLocalStorage();
                    showNotification('Transcription moved to text input!', 'success');
                    // Optionally switch to edit tab
                    const editTabButton = document.getElementById('edit-tab');
                    if (editTabButton) {
                        new bootstrap.Tab(editTabButton).show();
                    }
                } else {
                    showNotification('No transcription to use.', 'warning');
                }
            });

            // --- TTS Functions ---

            // Function to reset audio player state
            function resetAudioPlayer() {
                if (audioPlayer) {
                    audioPlayer.pause();
                    audioPlayer.currentTime = 0;
                    currentAudio = null;
                }
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                playPauseBtn.disabled = true; // Disable until new audio is loaded
                stopBtn.disabled = true; // Disable stop button
                downloadAudioBtn.disabled = true; // Disable download button
                progressBar.style.width = '0%';
                audioControls.style.display = 'none'; // Hide controls
                isPaused = false;
                isReading = false; // Ensure reading state is reset
            }

            // Event listener for Generate Speech Button
            readBtn.addEventListener('click', async function () {
                const text = textInput.value.trim();
                if (!text) {
                    showNotification('Please enter some text to generate speech.', 'warning');
                    return;
                }

                // Reset audio player state before generating new audio
                resetAudioPlayer();

                updateReadingStatus('Generating speech...', 'fas fa-circle-notch fa-spin');
                readBtn.disabled = true;

                const selectedVoiceId = voiceSelect.value;
                const selectedSpeed = speedSelect.value;
                const selectedFormat = outputFormatSelect.value;

                try {
                    const response = await fetch('/generate_speech', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            text: text,
                            voice_id: selectedVoiceId,
                            speed: parseFloat(selectedSpeed),
                            format: selectedFormat
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to generate speech');
                    }

                    const data = await response.json();
                    if (data.success && data.audio_url) {
                        currentAudio = data.audio_url; // Store the URL for playing and downloading
                        currentDownloadPath = data.audio_url; // Assuming audio_url is also the download path

                        audioPlayer.src = currentAudio;
                        audioPlayer.playbackRate = parseFloat(selectedSpeed); // Apply playback rate from dropdown
                        audioPlayer.load(); // Load the new audio
                        audioPlayer.play(); // Auto-play the new audio
                        isReading = true;

                        // Update UI for playing state
                        updateReadingStatus('Playing...', 'fas fa-volume-up');
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                        playPauseBtn.disabled = false; // Enable play/pause
                        stopBtn.disabled = false; // Enable stop
                        downloadAudioBtn.disabled = false; // Enable download
                        audioControls.style.display = 'flex'; // Show controls
                        showNotification('Speech generated and playing!', 'success');
                    } else {
                        showNotification(data.error || 'Unknown error generating speech.', 'error');
                        updateReadingStatus('Speech generation failed.', 'fas fa-times-circle');
                        resetAudioPlayer(); // Reset on error
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification(`Error: ${error.message}`, 'error');
                    updateReadingStatus('Speech generation failed.', 'fas fa-times-circle');
                    resetAudioPlayer(); // Reset on error
                } finally {
                    readBtn.disabled = false; // Re-enable generate button
                }
            });

            // Play/Pause Button
            playPauseBtn.addEventListener('click', function () {
                if (audioPlayer.paused && currentAudio) {
                    audioPlayer.play();
                    isPaused = false;
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    stopBtn.disabled = false;
                    updateReadingStatus('Playing...', 'fas fa-volume-up');
                } else if (currentAudio) {
                    audioPlayer.pause();
                    isPaused = true;
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    updateReadingStatus('Paused.', 'fas fa-pause-circle');
                }
            });

            // Stop Button - REVISED
            stopBtn.addEventListener('click', function () {
                resetAudioPlayer(); // Use the new reset function
                updateReadingStatus('Ready to generate speech.', 'fas fa-circle-check'); // Reset status message
                showNotification('Audio stopped.', 'info', 1500);
            });

            // Audio Player Event Listeners
            audioPlayer.addEventListener('timeupdate', function () {
                if (!isNaN(audioPlayer.duration)) {
                    const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                    progressBar.style.width = progress + '%';
                }
            });

            audioPlayer.addEventListener('ended', function () {
                console.log("Audio ended.");
                isReading = false;
                isPaused = false;
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                stopBtn.disabled = false;
                updateReadingStatus('Playback finished. Press play to replay or stop to clear.', 'fas fa-circle-check');
                showNotification('Audio playback finished.', 'info', 1500);
            });

            audioPlayer.addEventListener('error', function (e) {
                console.error('Audio playback error:', e);
                showNotification('Error playing audio. Please try again.', 'error');
                updateReadingStatus('Audio error.', 'fas fa-exclamation-circle');
                resetAudioPlayer(); // Reset player state on error
            });

            // Progress bar click to seek
            progressBarContainer.addEventListener('click', function (e) {
                if (currentAudio && !isNaN(audioPlayer.duration)) {
                    const clickX = e.clientX - progressBarContainer.getBoundingClientRect().left;
                    const percent = clickX / progressBarContainer.offsetWidth;
                    audioPlayer.currentTime = audioPlayer.duration * percent;
                }
            });

            // Volume control
            volumeControl.addEventListener('input', function () {
                audioPlayer.volume = parseFloat(this.value);
                localStorage.setItem('ttsKokoroVolume', this.value); // Save volume
            });

            // Load saved volume
            const savedVolume = localStorage.getItem('ttsKokoroVolume');
            if (savedVolume !== null) {
                volumeControl.value = savedVolume;
                audioPlayer.volume = parseFloat(savedVolume);
            }

            // Download Audio
            downloadAudioBtn.addEventListener('click', function () {
                if (currentDownloadPath) {
                    const link = document.createElement('a');
                    link.href = currentDownloadPath;
                    link.download = `tts_kokoro_audio_${new Date().getTime()}.${currentDownloadPath.split('.').pop()}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showNotification('Download started!', 'success');
                } else {
                    showNotification('No audio to download.', 'warning');
                }
            });

            // Voice preview button logic
            voicePreviewBtn.addEventListener('click', async function () {
                const selectedVoiceId = voiceSelect.value;
                const previewText = "This is a voice preview.";
                const selectedSpeed = speedSelect.value; // Use the selected speed for preview as well

                if (!previewText) {
                    showNotification('No text for preview.', 'warning');
                    return;
                }

                // Stop any currently playing audio (main or previous preview)
                resetAudioPlayer(); // This will clear currentAudio and disable buttons

                updateReadingStatus('Generating preview...', 'fas fa-circle-notch fa-spin');
                voicePreviewBtn.disabled = true; // Disable preview button during generation
                readBtn.disabled = true; // Also disable main generate button

                try {
                    const response = await fetch('/generate_speech', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: previewText,
                            voice_id: selectedVoiceId,
                            speed: parseFloat(selectedSpeed), // Use selected speed for preview
                            format: 'wav' // Always use WAV for preview for compatibility
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to generate preview audio');
                    }

                    const data = await response.json();
                    if (data.success && data.audio_url) {
                        const previewAudio = new Audio(data.audio_url);
                        previewAudio.playbackRate = parseFloat(selectedSpeed); // Apply speed to preview audio
                        previewAudio.load();
                        previewAudio.play();

                        updateReadingStatus('Playing preview...', 'fas fa-volume-up');

                        previewAudio.onended = () => {
                            updateReadingStatus('Ready to generate speech.', 'fas fa-circle-check');
                            voicePreviewBtn.disabled = false; // Re-enable preview button
                            readBtn.disabled = false; // Re-enable main generate button
                            showNotification('Preview finished.', 'info', 1500);
                        };

                        previewAudio.onerror = (e) => {
                            console.error('Preview audio loading error:', e);
                            showNotification("Failed to load preview audio.", "error");
                            updateReadingStatus("Preview audio error.", 'fas fa-exclamation-circle');
                            voicePreviewBtn.disabled = false;
                            readBtn.disabled = false;
                        };

                    } else {
                        showNotification(data.error || 'Unknown error generating preview.', 'error');
                        updateReadingStatus('Preview generation failed.', 'fas fa-times-circle');
                    }
                } catch (error) {
                    console.error('Preview Error:', error);
                    showNotification(`Preview Error: ${error.message}`, 'error');
                    updateReadingStatus('Preview generation failed.', 'fas fa-times-circle');
                } finally {
                    voicePreviewBtn.disabled = false; // Ensure button is re-enabled on complete or error
                    readBtn.disabled = false; // Ensure main generate button is re-enabled
                }
            });

            // Workflow Tab Changes (to reset audio when changing tabs)
            const workflowTabs = document.getElementById('workflowTabs');
            workflowTabs.addEventListener('shown.bs.tab', function (event) {
                // If moving away from the TTS tab, stop any playing audio
                if (event.relatedTarget && event.relatedTarget.id === 'tts-tab') {
                    resetAudioPlayer();
                    updateReadingStatus('Ready to generate speech.', 'fas fa-circle-check');
                }
            });

            // Template and History/Snippets (Placeholder - assuming existing functionality)
            const templatesList = document.getElementById('templatesList');
            templatesList.addEventListener('click', function (e) {
                if (e.target.tagName === 'A' && e.target.dataset.template) {
                    e.preventDefault();
                    const templateName = e.target.dataset.template;
                    let templateText = "";
                    switch (templateName) {
                        case "Welcome message":
                            templateText = "Hello and welcome to TTS KOKORO! This is a simple text-to-speech application. Feel free to generate speech from your text.";
                            break;
                        case "Announcement":
                            templateText = "Attention all users: We are excited to announce new updates coming soon. Stay tuned for more features and improvements!";
                            break;
                        case "Quick test":
                            templateText = "The quick brown fox jumps over the lazy dog. This is a test of the text-to-speech system.";
                            break;
                        default:
                            templateText = "Selected template has no defined text.";
                    }
                    textInput.value = templateText;
                    textInput.dispatchEvent(new Event('input')); // Trigger input event to update char count and save
                    showNotification(`Template "${templateName}" loaded.`, 'info');
                    // Switch to edit tab
                    const editTabButton = document.getElementById('edit-tab');
                    if (editTabButton) {
                        new bootstrap.Tab(editTabButton).show();
                    }
                }
            });

            // Initialize - important for initial state
            updateReadingStatus("Ready to generate speech.", 'fas fa-circle-check');
            resetAudioPlayer(); // Call reset on initialization
            checkSTTAvailability();
            initializeSpeechRecognition();
        });
    </script>
</body>

</html>
